---
name: Release
"on":
  push:
    tags:
      - v*.*.*
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write  # Required for crates.io trusted publishing

jobs:
  # 1. PUBLISH TO CRATES.IO
  publish-registry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail
          cargo publish --workspace --all-features || echo "already published"

  # 2. DOCKER CONTAINER (GHCR)
  publish-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: >
            ghcr.io/${{ github.repository }}:latest,
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}

  # 3. OS INSTALLERS (.exe, .msi, .deb, .rpm)
  # Use cargo-dist for cross-platform installers
  publish-assets:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: aarch64-apple-darwin
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      # Install packaging tools
      - name: Install Tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y rpm binutils

      # Use cargo-dist to build installers
      - name: Install cargo-dist
        run: |
          GH_URL="https://github.com/axodotdev/cargo-dist/releases/latest"
          FULL_URL="$GH_URL/download/cargo-dist-installer.sh"
          curl --proto '=https' --tlsv1.2 -LsSf "$FULL_URL" | sh

      - name: Build Release Assets
        run: |
          cargo dist build \
            --tag="${{ github.ref_name }}" \
            --output-format=json

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: target/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
